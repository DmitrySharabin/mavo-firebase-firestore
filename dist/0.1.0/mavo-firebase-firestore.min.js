(function(a){const b=Mavo.Backend.register(a.Class({extends:Mavo.Backend,id:"Firebase",constructor:function(c,{mavo:d,format:e}){this.permissions.on("read"),this.defaults={filename:d.id,storageName:d.element.getAttribute("mv-firebase-storage")||d.id,features:{auth:!0,storage:!0}},a.extend(this,this.defaults),template=d.element.getAttribute("mv-firebase")||"",this.features=b.getFeatures(template,this.features),this.features.auth?this.permissions.on("login"):this.permissions.on(["edit","add","delete","save"]),this.ready=a.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js").then(async()=>{await Promise.all([a.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-firestore.js"),a.include(!this.features.storage,"https://www.gstatic.com/firebasejs/7.8.2/firebase-storage.js"),a.include(!this.features.auth,"https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js")]),a.extend(this,b.parseURL(c,this.defaults));const e={apiKey:d.element.getAttribute("mv-firebase-key"),databaseURL:this.databaseURL,projectId:this.projectId,authDomain:`${this.projectId}.firebaseapp.com`,storageBucket:`${this.projectId}.appspot.com`};return this.app=firebase.apps.length?firebase.initializeApp(e,d.id):firebase.initializeApp(e),this.db=firebase.firestore().collection("mavo-apps"),d.element.hasAttribute("mv-firebase-realtime")?this.unsubscribe=this.db.doc(this.filename).onSnapshot(a=>{a.metadata.hasPendingWrites?"Local":"Server";d.render(a.data())},a=>d.error(`Firebase: ${a.message}`)):this.unsubscribe&&this.unsubscribe(),this.features.storage&&(this.storageBucketRef=firebase.storage().ref()),this.features.auth&&firebase.auth().onAuthStateChanged(b=>{b?(this.user={username:b.email,name:b.displayName,avatar:b.photoURL},a.fire(d.element,"mv-login",{backend:this}),this.permissions.off("login").on(["edit","add","delete","save","logout"])):(this.user=null,a.fire(d.element,"mv-logout",{backend:this}),this.permissions.off(["edit","add","delete","save","logout"]).on("login"))}),Promise.resolve()}),this.features.auth&&this.login(!0)},update:function(c,d){this.super.update.call(this,c,d),a.extend(this,b.parseURL(c,this.defaults))},get:function(a){return this.db.doc(a).get()},load:function(){return this.ready.then(()=>this.get(this.filename).then(a=>Promise.resolve(a.data()||{})).catch(a=>this.mavo.error(`Firebase: ${a.message}`)))},put:function(a,b=this.path,c={}){return this.storageBucketRef.child(b).put(a).then(a=>a.ref.getDownloadURL())},upload:function(a,b){return b=`${this.storageName}/${b}`,this.put(a,b).then(a=>a)},store:function(a,{path:b,format:c=this.format}={}){return this.db.doc(this.filename).set(a).then(()=>Promise.resolve()).catch(a=>this.mavo.error(`Firebase: ${a.message}`))},login:function(a){return this.ready.then(()=>this.user?Promise.resolve(this.user):new Promise((b,c)=>{if(a)b(this.user);else{const a=new firebase.auth.GoogleAuthProvider;this.app.auth().signInWithPopup(a).catch(a=>{this.mavo.error(`Firebase: ${a.message}`),c(a)})}}))},logout:function(){return this.app.auth().signOut().catch(a=>{this.mavo.error(`Firebase: ${a.message}`)})},static:{test:function(a){return /^https:\/\/.*\.firebaseio\.com(\/)?/.test(a.trim())},parseURL:function(a,b={}){const c={},d=new URL(a);return c.databaseURL=d.hostname,c.projectId=d.hostname.split(".").shift(),c.filename=d.pathname.slice(1)||b.filename,c},getFeatures:function(a,b){const c=b,d=Object.keys(b);if(a&&(a=a.trim())){const b=/^with\s|\bno-\w+\b/.test(a);let e=a.split(/\s+/);return e=Mavo.Functions.unique(e.reverse()).reverse(),b&&(e=d.filter(a=>{var b=Math.max;const c=e.lastIndexOf(a),d=e.lastIndexOf("no-"+a),f=c>b(-1,d),g=d>b(-1,c);return f||!g})),d.forEach(a=>e.includes(a)?c[a]=!0:c[a]=!1),c}return c}}}))})(Bliss);