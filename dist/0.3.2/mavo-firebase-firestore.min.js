(function($){"use strict";const PROVIDERS={google:{},facebook:{},twitter:{},github:{}};Mavo.Plugins.register("firebase-firestore",{dependencies:["mavo-firebase-firestore.css"],hooks:{"init-start":function(a){Object.keys(PROVIDERS).forEach(b=>{const c=`firebase-auth-${b}`;Mavo.UI.Bar.controls[c]={create:function(b){return b||$.create("button",{type:"button",className:`mv-${c}`,textContent:a._(c)})},action:function(){a.primaryBackend.provider=b,a.primaryBackend.login(!1)},permission:"login",condition:function(){return!!a.primaryBackend.projectId&&a.primaryBackend.authProviders.includes(b)}}}),$.extend(Mavo.UI.Bar.controls.login,{condition:function(){return!!a.primaryBackend.projectId&&!a.primaryBackend.authProviders.length}})}}});const _=Mavo.Backend.register($.Class({extends:Mavo.Backend,id:"Firebase",constructor:function(a,{mavo:b,format:c}){this.permissions.on("read"),this.defaults={collection:"mavo-apps",filename:b.id,storageName:b.element.getAttribute("mv-firebase-storage")||b.id,features:{auth:!1,storage:!1,realtime:!1},authProviders:_.getAuthProviders(b.element.getAttribute("mv-firebase-auth")||"",PROVIDERS),provider:void 0},$.extend(this,this.defaults);const d=b.element.getAttribute("mv-firebase")||"";this.features=_.getOptions(d,this.features),this.authProviders.length&&(this.features.auth=!0),this.features.auth?(this.permissions.on("login"),!this.authProviders.length&&(this.provider="google")):this.permissions.on(["edit","save"]),this.ready=$.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js").then(async()=>{await Promise.all([$.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-firestore.js"),$.include(!this.features.storage,"https://www.gstatic.com/firebasejs/7.8.2/firebase-storage.js"),$.include(!this.features.auth,"https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js")]),$.extend(this,_.parseSource(this.source,this.defaults));const a={apiKey:b.element.getAttribute("mv-firebase-key"),databaseURL:`https://${this.projectId}.firebaseio.com`,projectId:this.projectId,authDomain:`${this.projectId}.firebaseapp.com`,storageBucket:`${this.projectId}.appspot.com`};return this.app=firebase.apps.length?firebase.apps.find(a=>a.options.projectId===this.projectId)||firebase.initializeApp(a,this.projectId):firebase.initializeApp(a),this.app.firestore()._persistenceKey||this.app.firestore().enablePersistence({synchronizeTabs:!0}).catch(a=>{"unimplemented"===a.code&&(Mavo.warn(this.mavo._("firebase-offline-unimplemented")),this.mavo.error(`Firebase Offline: ${a.message}`))}),this.db=this.app.firestore().collection(this.collection),this.features.realtime?this.unsubscribe=this.db.doc(this.filename).onSnapshot(a=>_.updatesHandler(a,b),a=>b.error(`Firebase Realtime: ${a.message}`)):this.unsubscribe&&this.unsubscribe(),this.features.storage&&(this.storageBucketRef=this.app.storage().ref()),this.features.auth&&this.app.auth().onAuthStateChanged(a=>{a?(this.user={username:a.email,name:a.displayName,avatar:a.photoURL,user:a},$.fire(b.element,"mv-login",{backend:this}),this.permissions.off("login").on(["edit","save","logout"])):(this.user=null,$.fire(b.element,"mv-logout",{backend:this}),this.permissions.off(["edit","add","delete","save","logout"]).on("login"))}),Promise.resolve()})},update:function(a,b){this.super.update.call(this,a,b),$.extend(this,_.parseSource(this.source,this.defaults)),this.app&&(this.db=this.app.firestore().collection(this.collection),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=this.db.doc(this.filename).onSnapshot(a=>_.updatesHandler(a,b.mavo),a=>b.mavo.error(`Firebase Realtime: ${a.message}`))))},get:function(a){return this.db.doc(a).get()},load:function(){return navigator.onLine||setTimeout(()=>this.mavo.inProgress=!1,300),this.ready.then(()=>this.get(this.filename).then(a=>Promise.resolve(a.data()||{})).catch(a=>{Mavo.warn(this.mavo._("firebase-check-security-rules")),this.mavo.error(`Firebase Load Data: ${a.message}`)}))},put:function(a,b=this.path,c={}){return this.storageBucketRef?this.storageBucketRef.child(b).put(a).then(a=>a.ref.getDownloadURL()):(Mavo.warn(this.mavo._("firebase-enable-storage")),Promise.reject(Error(`Firebase Storage: ${this.mavo._("firebase-enable-storage")}`)))},upload:function(a,b){return b=`${this.storageName}/${b}`,this.put(a,b).then(a=>a).catch(a=>{a.code&&(this.features.auth?Mavo.warn(this.mavo._("firebase-check-security-rules")):Mavo.warn(this.mavo._("firebase-enable-auth"))),this.mavo.error(`${a.message}`)})},store:function(a,{path:b,format:c=this.format}={}){return navigator.onLine||setTimeout(()=>this.mavo.inProgress=!1,300),this.db.doc(this.filename).set(a).then(()=>Promise.resolve()).catch(a=>{Mavo.warn(this.mavo._("firebase-enable-auth")),Mavo.warn(this.mavo._("firebase-check-security-rules")),this.mavo.error(`Firebase Auth: ${a.message}`)})},login:function(a){return this.ready.then(()=>new Promise((b,c)=>{a?b(this.user):(firebase.auth().useDeviceLanguage(),this.app.auth().signInWithPopup(_.buildProvider(this.provider)).catch(a=>{this.mavo.error(`Firebase Auth: ${a.message}`),c(a)}))}))},logout:function(){return this.app.auth().signOut().catch(a=>{this.mavo.error(`Firebase Auth: ${a.message}`)})},static:{test:function(a){return a=a.trim(),/^https:\/\/.*\.firebaseio\.com\/?/.test(a)||/^firebase:\/\/.*/.test(a)},parseSource:function(a,b={}){const c={};if(/^https:\/\/.*\.firebaseio\.com\/?/.test(a)){const b=new URL(a);c.projectId=b.hostname.split(".").shift(),a=b.pathname.slice(1)}else a=a.replace("firebase://","");if(-1<a.indexOf("/")){const d=a.split("/");c.projectId=c.projectId||d.shift(),c.filename=d.length%2?b.filename:d.pop(),c.collection=d.join("/")}else c.projectId=c.projectId||a,c.collection=b.collection,c.filename=b.filename;return c},getOptions:function(a,b){const c=b,d=Object.keys(b);if(a=a?.trim()){let b=a.split(/\s+/);return b=Mavo.Functions.unique(b.reverse()).reverse(),d.forEach(a=>b.includes(a)?c[a]=!0:c[a]=!1),c}return c},updatesHandler:function(a,b){const c=a.metadata.hasPendingWrites?"Local":"Server";"Server"==c&&b.render(a.data())},getAuthProviders:function(a,b){const c=Object.keys(b);if(a=a?.trim()){let b=a.split(/\s+/);return b=Mavo.Functions.unique(b.map(a=>a.toLowerCase())),b=b.filter(a=>c.includes(a)),b}return[]},buildProvider:function(provider){return provider=provider||"google",provider=provider.charAt(0).toUpperCase()+provider.slice(1),eval(`new firebase.auth.${provider}AuthProvider()`)}}}));Mavo.Locale.register("en",{"firebase-enable-auth":"You might need to enable authorization in your app. To do so, add mv-firebase=\"auth\" to the Mavo root.","firebase-enable-storage":"It seems your app does not support uploads. To enable uploads, add mv-firebase=\"storage\" to the Mavo root.","firebase-check-security-rules":"Please check the security rules for your app. They might be inappropriately set. For details, see https://plugins.mavo.io/plugin/firebase-firestore#security-rules-examples.","firebase-offline-unimplemented":"The current browser does not support all of the features required to enable offline persistence. This feature is supported only by Chrome, Safari, and Firefox web browsers.","firebase-auth-google":"Google","firebase-auth-facebook":"Facebook","firebase-auth-twitter":"Twitter","firebase-auth-github":"GitHub"})})(Bliss);