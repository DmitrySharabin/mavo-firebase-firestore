"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}(function(a){"use strict";var b=Mavo.Backend.register(a.Class({extends:Mavo.Backend,id:"Firebase",constructor:function(c,d){var e=this,f=d.mavo,g=d.format;this.permissions.on("read"),this.defaults={collection:"mavo-apps",filename:f.id,storageName:f.element.getAttribute("mv-firebase-storage")||f.id,features:{auth:!1,storage:!1,realtime:!1}},a.extend(this,this.defaults);var h=f.element.getAttribute("mv-firebase")||"";this.features=b.getOptions(h,this.features),this.features.auth?this.permissions.on("login"):this.permissions.on(["edit","save"]),this.ready=a.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js").then(_asyncToGenerator(regeneratorRuntime.mark(function c(){var d;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,Promise.all([a.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-firestore.js"),a.include(!e.features.storage,"https://www.gstatic.com/firebasejs/7.8.2/firebase-storage.js"),a.include(!e.features.auth,"https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js")]);case 2:return a.extend(e,b.parseSource(e.source,e.defaults)),d={apiKey:f.element.getAttribute("mv-firebase-key"),databaseURL:"https://".concat(e.projectId,".firebaseio.com"),projectId:e.projectId,authDomain:"".concat(e.projectId,".firebaseapp.com"),storageBucket:"".concat(e.projectId,".appspot.com")},e.app=firebase.apps.length?firebase.initializeApp(d,f.id):firebase.initializeApp(d),e.app.firestore().enablePersistence({synchronizeTabs:!0})["catch"](function(a){"unimplemented"===a.code&&(Mavo.warn(e.mavo._("firebase-offline-unimplemented")),e.mavo.error("Firebase Offline: ".concat(a.message)))}),e.db=e.app.firestore().collection(e.collection),e.features.realtime?e.unsubscribe=e.db.doc(e.filename).onSnapshot(function(a){var b=a.metadata.hasPendingWrites?"Local":"Server";"Server"==b&&f.render(a.data())},function(a){return f.error("Firebase Realtime: ".concat(a.message))}):e.unsubscribe&&e.unsubscribe(),e.features.storage&&(e.storageBucketRef=e.app.storage().ref()),e.features.auth&&e.app.auth().onAuthStateChanged(function(b){b?(e.user={username:b.email,name:b.displayName,avatar:b.photoURL,user:b},a.fire(f.element,"mv-login",{backend:e}),e.permissions.off("login").on(["edit","save","logout"])):(e.user=null,a.fire(f.element,"mv-logout",{backend:e}),e.permissions.off(["edit","add","delete","save","logout"]).on("login"))}),c.abrupt("return",Promise.resolve());case 11:case"end":return c.stop();}},c)}))),this.features.auth&&this.login(!0)},update:function(c,d){this["super"].update.call(this,c,d),a.extend(this,b.parseSource(this.source,this.defaults))},get:function(a){return this.db.doc(a).get()},load:function(){var a=this;return navigator.onLine||setTimeout(function(){return a.mavo.inProgress=!1},300),this.ready.then(function(){return a.get(a.filename).then(function(a){return Promise.resolve(a.data()||{})})["catch"](function(b){Mavo.warn(a.mavo._("firebase-check-security-rules")),a.mavo.error("Firebase Load Data: ".concat(b.message))})})},put:function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.path,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};return this.storageBucketRef?this.storageBucketRef.child(b).put(a).then(function(a){return a.ref.getDownloadURL()}):(Mavo.warn(this.mavo._("firebase-enable-storage")),Promise.reject(Error("Firebase Storage: ".concat(this.mavo._("firebase-enable-storage")))))},upload:function(a,b){var c=this;return b="".concat(this.storageName,"/").concat(b),this.put(a,b).then(function(a){return a})["catch"](function(a){a.code&&(c.features.auth?Mavo.warn(c.mavo._("firebase-check-security-rules")):Mavo.warn(c.mavo._("firebase-enable-auth"))),c.mavo.error("".concat(a.message))})},store:function(a){var b=this,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.path,e=c.format,f=void 0===e?this.format:e;return navigator.onLine||setTimeout(function(){return b.mavo.inProgress=!1},300),this.db.doc(this.filename).set(a).then(function(){return Promise.resolve()})["catch"](function(a){Mavo.warn(b.mavo._("firebase-enable-auth")),Mavo.warn(b.mavo._("firebase-check-security-rules")),b.mavo.error("Firebase Auth: ".concat(a.message))})},login:function(a){var b=this;return this.ready.then(function(){return new Promise(function(c,d){if(a)c(b.user);else{var e=new firebase.auth.GoogleAuthProvider;firebase.auth().useDeviceLanguage(),b.app.auth().signInWithPopup(e).then(function(a){for(var c in Mavo.all){var d=Mavo.all[c].primaryBackend;d&&d.id===b.id&&d!==b&&d.features.auth&&!d.user&&d.app.auth().signInWithCredential(a.credential)}})["catch"](function(a){b.mavo.error("Firebase Auth: ".concat(a.message)),d(a)})}})})},logout:function(){var a=this;return this.app.auth().signOut()["catch"](function(b){a.mavo.error("Firebase Auth: ".concat(b.message))})},static:{test:function(a){return a=a.trim(),/^https:\/\/.*\.firebaseio\.com\/?/.test(a)||/^(?!https?\:\/\/).*$/.test(a)&&!["local","none"].includes(a)&&0!==a.indexOf("#")},parseSource:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c={};if(/^https:\/\/.*\.firebaseio\.com\/?/.test(a)){var d=new URL(a);c.projectId=d.hostname.split(".").shift(),a=d.pathname.slice(1)}if(-1<a.indexOf("/")){var e=a.split("/");c.projectId=c.projectId||e.shift(),c.filename=e.length%2?b.filename:e.pop(),c.collection=e.join("/")}else c.projectId=c.projectId||a,c.collection=b.collection,c.filename=b.filename;return c},getOptions:function(a,b){var c=b,d=Object.keys(b);if(a&&(a=a.trim())){var e=a.split(/\s+/);return e=Mavo.Functions.unique(e.reverse()).reverse(),d.forEach(function(a){return e.includes(a)?c[a]=!0:c[a]=!1}),c}return c}}}));Mavo.Locale.register("en",{"firebase-enable-auth":"You might need to enable authorization in your app. To do so, add mv-firebase=\"auth\" to the Mavo root.","firebase-enable-storage":"It seems your app does not support uploads. To enable uploads, add mv-firebase=\"storage\" to the Mavo root.","firebase-check-security-rules":"Please check the security rules for your app. They might be inappropriately set. For details, see https://plugins.mavo.io/plugin/firebase-firestore#security-rules-examples.","firebase-offline-unimplemented":"The current browser does not support all of the features required to enable offline persistence. This feature is supported only by Chrome, Safari, and Firefox web browsers."})})(Bliss);