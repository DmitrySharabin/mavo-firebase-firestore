"use strict";function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}(function(a){var b=Mavo.Backend.register(a.Class({extends:Mavo.Backend,id:"Firebase",constructor:function(c,d){var e=this,f=d.mavo,g=d.format;this.permissions.on("read"),this.defaults={collectionName:"mavo-apps",filename:f.id,storageName:f.element.getAttribute("mv-firebase-storage")||f.id,features:{auth:!0,storage:!0}},a.extend(this,this.defaults),template=f.element.getAttribute("mv-firebase")||"",this.features=b.getFeatures(template,this.features),this.features.auth?this.permissions.on("login"):this.permissions.on(["edit","save"]),this.ready=a.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js").then(_asyncToGenerator(regeneratorRuntime.mark(function c(){var d;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,Promise.all([a.load("https://www.gstatic.com/firebasejs/7.8.2/firebase-firestore.js"),a.include(!e.features.storage,"https://www.gstatic.com/firebasejs/7.8.2/firebase-storage.js"),a.include(!e.features.auth,"https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js")]);case 2:return a.extend(e,b.parseURL(e.source,e.defaults)),d={apiKey:f.element.getAttribute("mv-firebase-key"),databaseURL:e.databaseURL,projectId:e.projectId,authDomain:"".concat(e.projectId,".firebaseapp.com"),storageBucket:"".concat(e.projectId,".appspot.com")},e.app=firebase.apps.length?firebase.initializeApp(d,f.id):firebase.initializeApp(d),e.db=e.app.firestore().collection(e.collectionName),f.element.hasAttribute("mv-firebase-realtime")?e.unsubscribe=e.db.doc(e.filename).onSnapshot(function(a){a.metadata.hasPendingWrites?"Local":"Server";f.render(a.data())},function(a){return f.error("Firebase: ".concat(a.message))}):e.unsubscribe&&e.unsubscribe(),e.features.storage&&(e.storageBucketRef=e.app.storage().ref()),e.features.auth&&e.app.auth().onAuthStateChanged(function(b){b?(e.user={username:b.email,name:b.displayName,avatar:b.photoURL,user:b},a.fire(f.element,"mv-login",{backend:e}),e.permissions.off("login").on(["edit","save","logout"])):(e.user=null,a.fire(f.element,"mv-logout",{backend:e}),e.permissions.off(["edit","add","delete","save","logout"]).on("login"))}),c.abrupt("return",Promise.resolve());case 10:case"end":return c.stop();}},c)}))),this.features.auth&&this.login(!0)},update:function(c,d){this["super"].update.call(this,c,d),a.extend(this,b.parseURL(this.source,this.defaults))},get:function(a){return this.db.doc(a).get()},load:function(){var a=this;return this.ready.then(function(){return a.get(a.filename).then(function(a){return Promise.resolve(a.data()||{})})["catch"](function(b){return a.mavo.error("Firebase: ".concat(b.message))})})},put:function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.path,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};return this.storageBucketRef.child(b).put(a).then(function(a){return a.ref.getDownloadURL()})},upload:function(a,b){return b="".concat(this.storageName,"/").concat(b),this.put(a,b).then(function(a){return a})},store:function(a){var b=this,c=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},d=c.path,e=c.format,f=void 0===e?this.format:e;return this.db.doc(this.filename).set(a).then(function(){return Promise.resolve()})["catch"](function(a){return b.mavo.error("Firebase: ".concat(a.message))})},login:function(a){var b=this;return this.ready.then(function(){return b.user?Promise.resolve():new Promise(function(c,d){if(a)c(b.user);else{var e=new firebase.auth.GoogleAuthProvider;e.addScope("https://www.googleapis.com/auth/cloud-platform"),firebase.auth().useDeviceLanguage(),b.app.auth().signInWithPopup(e)["catch"](function(a){b.mavo.error("Firebase: ".concat(a.message)),d(a)})}})})},logout:function(){var a=this;return this.app.auth().signOut()["catch"](function(b){a.mavo.error("Firebase: ".concat(b.message))})},static:{test:function(a){return /^https:\/\/.*\.firebaseio\.com(\/)?/.test(a.trim())},parseURL:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c={},d=new URL(a);c.databaseURL=d.hostname,c.projectId=d.hostname.split(".").shift();var e=d.pathname.slice(1);if(-1<e.indexOf("/")){var f=e.split("/"),g=_slicedToArray(f,2);c.collectionName=g[0],c.filename=g[1]}else c.collectionName=b.collectionName,c.filename=e||b.filename;return c},getFeatures:function(a,b){var c=b,d=Object.keys(b);if(a&&(a=a.trim())){var e=/^with\s|\bno-\w+\b/.test(a),f=a.split(/\s+/);return f=Mavo.Functions.unique(f.reverse()).reverse(),e&&(f=d.filter(function(a){var b=Math.max,c=f.lastIndexOf(a),d=f.lastIndexOf("no-"+a),e=c>b(-1,d),g=d>b(-1,c);return e||!g})),d.forEach(function(a){return f.includes(a)?c[a]=!0:c[a]=!1}),c}return c}}}))})(Bliss);